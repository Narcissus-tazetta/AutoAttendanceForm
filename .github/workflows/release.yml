name: Build and Release Extensions

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:
        inputs:
            version:
                description: "Release version (e.g., 1.0.0)"
                required: true
                type: string

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1
              with:
                  bun-version: latest

            - name: Install dependencies
              run: bun install

            - name: Type check
              run: bun run typecheck

            - name: Build fonts and CSS
              run: |
                  bun run build:fonts
                  bun run build:css

            - name: Build Chrome extension
              run: bun run build:chrome

            - name: Build Firefox extension
              run: bun run build:firefox

            - name: Package Chrome extension
              run: bun run package:chrome

            - name: Package Firefox extension (unsigned)
              run: bun run package:firefox

            - name: Sign Firefox extension
              if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
              env:
                  WEB_EXT_API_KEY: ${{ secrets.AMO_JWT_ISSUER }}
                  WEB_EXT_API_SECRET: ${{ secrets.AMO_JWT_SECRET }}
              run: |
                  mkdir -p build/signed
                  bun run sign:firefox

            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: extension-builds
                  path: |
                      build/è‡ªå‹•å‡ºå¸­ãƒ•ã‚©ãƒ¼ãƒ  chrome.zip
                      build/è‡ªå‹•å‡ºå¸­ãƒ•ã‚©ãƒ¼ãƒ  firefox.zip
                      build/signed/*.xpi

    release:
        needs: build
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

        steps:
            - name: Download artifacts
              uses: actions/download-artifact@v4
              with:
                  name: extension-builds
                  path: ./artifacts

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      ./artifacts/build/è‡ªå‹•å‡ºå¸­ãƒ•ã‚©ãƒ¼ãƒ  chrome.zip
                      ./artifacts/build/è‡ªå‹•å‡ºå¸­ãƒ•ã‚©ãƒ¼ãƒ  firefox.zip
                      ./artifacts/build/signed/*.xpi
                  body: |
                      ## ğŸš€ æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹

                      ### Chromeæ‹¡å¼µæ©Ÿèƒ½
                      - `è‡ªå‹•å‡ºå¸­ãƒ•ã‚©ãƒ¼ãƒ  chrome.zip` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹
                      - Chromeæ‹¡å¼µæ©Ÿèƒ½ãƒšãƒ¼ã‚¸ã§ã€Œãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–ã•ã‚Œã¦ã„ãªã„æ‹¡å¼µæ©Ÿèƒ½ã‚’èª­ã¿è¾¼ã‚€ã€

                      ### Firefoxæ‹¡å¼µæ©Ÿèƒ½
                      #### é–‹ç™ºç”¨ï¼ˆæœªç½²åï¼‰
                      - `è‡ªå‹•å‡ºå¸­ãƒ•ã‚©ãƒ¼ãƒ  firefox.zip` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹
                      - about:debugging ã§ã€Œä¸€æ™‚çš„ãªã‚¢ãƒ‰ã‚ªãƒ³ã€ã¨ã—ã¦èª­ã¿è¾¼ã¿

                      #### æœ¬ç•ªç”¨ï¼ˆç½²åæ¸ˆã¿ï¼‰
                      - `.xpi` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Firefoxã§ç›´æ¥é–‹ã„ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

                      ### å¤‰æ›´ç‚¹
                      - è©³ç´°ã¯ [CHANGELOG.md](CHANGELOG.md) ã‚’å‚ç…§
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Build Extensions (Personal Distribution)

on:
    push:
        tags:
            - "v*"
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v1

            - name: Install dependencies
              run: bun install

            - name: Type check
              run: bun run typecheck

            - name: Build all
              run: bun run build:all

            - name: Build Firefox
              run: bun run build:firefox

            - name: Package Chrome
              run: bun run package:chrome

            - name: Package Firefox (unsigned)
              run: bun run package:firefox

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      build/自動出席フォーム chrome.zip
                      build/自動出席フォーム firefox.zip
                  body: |
                      ## 🚀 自動出席フォーム拡張機能

                      ### Chrome
                      1. `自動出席フォーム chrome.zip` をダウンロード・展開
                      2. Chrome拡張機能ページで「パッケージ化されていない拡張機能を読み込む」

                      ### Firefox（未署名版）
                      1. `自動出席フォーム firefox.zip` をダウンロード・展開  
                      2. `about:debugging` → 「一時的なアドオン」→ `manifest.json` を選択

                      ⚠️ **注意**: Firefox版は再起動で無効化されます

                      ### インストール詳細
                      - [Chrome インストールガイド](https://github.com/${{ github.repository }}/blob/main/docs/install-chrome.md)
                      - [Firefox インストールガイド](https://github.com/${{ github.repository }}/blob/main/docs/install-firefox.md)
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
